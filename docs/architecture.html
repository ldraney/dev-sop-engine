<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>dev-sop-engine - Architecture</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; line-height: 1.6; }
    h1, h2, h3 { margin-top: 2rem; }
    pre { background: #f4f4f4; padding: 1rem; overflow-x: auto; border-radius: 4px; }
    code { background: #f4f4f4; padding: 0.2rem 0.4rem; border-radius: 2px; }
    .nav { margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid #ddd; }
    .nav a { margin-right: 1rem; }
  </style>
</head>
<body>
  <nav class="nav">
    <a href="index.html">Home</a>
    <a href="architecture.html"><strong>Architecture</strong></a>
    <a href="user-story.html">User Stories</a>
    <a href="roadmap.html">Roadmap</a>
  </nav>

  <h1>Architecture</h1>

  <h2>Overview</h2>
  <p>dev-sop-engine is a CLI and MCP server that generates a portable <code>.claude/</code> directory and <code>.mcp.json</code> from a single <code>sop.json</code> configuration file.</p>

  <h2>Core Concept</h2>
  <pre>
sop/sop.json (source of truth)
    ↓
npx dev-sop-engine .
    ↓
.claude/ + .mcp.json (generated, portable)
  </pre>

  <h2>Repository Structure</h2>
  <pre>
dev-sop-engine/
├── CLAUDE.md
├── package.json
├── src/
│   ├── index.ts                   # CLI entry point
│   ├── generator.ts               # All generation logic (~280 lines)
│   └── mcp-server.ts              # MCP server mode (~85 lines)
│
├── sop/                           # Dogfood: our own config
│   ├── sop.json
│   ├── validators/
│   ├── loggers/
│   ├── hooks/
│   ├── skills/
│   └── agents/
│
├── .claude/                       # Generated (dogfood)
├── .mcp.json                      # Generated (dogfood)
└── docs/                          # GitHub Pages site
  </pre>

  <h2>Source vs Generated</h2>
  <p>Users maintain source files in <code>sop/</code>. The generator copies everything into <code>.claude/</code> to create a self-contained, portable output.</p>
  <pre>
project/
├── sop/                           # Source of truth (edit these)
│   ├── sop.json                   # Configuration
│   ├── validators/                # Rule validator scripts
│   ├── loggers/                   # Log handler scripts
│   ├── hooks/                     # Hook entry point (engine.sh)
│   ├── skills/                    # Skill markdown files
│   └── agents/                    # Agent prompt files
│
├── .claude/                       # GENERATED (portable)
│   ├── settings.json              # Hook wiring for all events
│   ├── sop.json                   # Copied for runtime reference
│   ├── hooks/
│   │   ├── engine.sh              # Hook router (dispatches to validators/loggers)
│   │   ├── validators/            # Copied with executable permissions
│   │   └── loggers/               # Copied with executable permissions
│   ├── skills/
│   │   └── &lt;name&gt;/SKILL.md       # Copied from content_file
│   └── agents/
│       └── &lt;name&gt;.md             # With YAML frontmatter injected
│
└── .mcp.json                      # GENERATED (merged with manual entries)
  </pre>

  <h2>sop.json Schema</h2>
  <p>The configuration file has these top-level sections:</p>
  <ul>
    <li><strong>version</strong> - Schema version (currently "1.0")</li>
    <li><strong>enforcement</strong> - "hard" blocks on violations, "soft" warns only</li>
    <li><strong>rules</strong> - Validators that run on hook events</li>
    <li><strong>logging</strong> - Structured event logging configuration</li>
    <li><strong>subagents</strong> - Inheritance settings for Task agents</li>
    <li><strong>mcp</strong> - MCP server definitions</li>
    <li><strong>skills</strong> - Reusable context files invoked with /name</li>
    <li><strong>agents</strong> - Specialized sub-agents for the Task tool</li>
  </ul>
  <pre>
{
  "version": "1.0",
  "enforcement": "hard",

  "rules": {
    "no-main-commit": {
      "description": "Block commits on main branch",
      "events": ["PreToolUse"],
      "matcher": "Bash",
      "condition": "git.*commit",
      "validator": "validators/no-main-commit.sh",
      "enabled": true
    }
  },

  "logging": {
    "enabled": true,
    "stderr": true,
    "file": "~/.claude/logs/sop-hooks.jsonl",
    "events": ["PreToolUse", "Stop"],
    "handler": "loggers/log-event.sh"
  },

  "subagents": { "inherit_rules": true },

  "mcp": {
    "github": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-github"],
      "env": { "GITHUB_TOKEN": "${GITHUB_TOKEN}" }
    }
  },

  "skills": {
    "workflow": {
      "description": "Project workflow",
      "content_file": "./skills/workflow.md"
    }
  },

  "agents": {
    "reviewer": {
      "description": "Code review specialist",
      "model": "sonnet",
      "tools": ["Read", "Grep", "Glob"],
      "prompt_file": "./agents/reviewer.md"
    }
  }
}
  </pre>

  <h2>Generator Behavior</h2>
  <ul>
    <li><strong>Source selection</strong> - Prefers the target project's <code>sop/</code> directory; falls back to the engine's defaults</li>
    <li><strong>Conditional generation</strong> - If <code>.claude/</code> already exists, skips regeneration and only updates <code>.mcp.json</code></li>
    <li><strong>Executable permissions</strong> - Validator and logger scripts get <code>chmod 755</code> automatically</li>
    <li><strong>Settings wiring</strong> - Generates hook entries for all 11 Claude Code events, routing through <code>engine.sh</code></li>
    <li><strong>MCP merge</strong> - Preserves manually-added servers in <code>.mcp.json</code>, tracks managed servers via <code>_managedBy</code> and <code>_managedServers</code> metadata</li>
  </ul>

  <h2>MCP Server Mode</h2>
  <p>The engine also runs as an MCP server, exposing <code>sop_generate</code> as a tool. This means any Claude Code session can generate <code>.claude/</code> for a target directory without using the CLI directly.</p>

  <h2>Design Decisions</h2>
  <ul>
    <li><strong>Copy, don't reference</strong> - Generated <code>.claude/</code> is fully portable and self-contained</li>
    <li><strong>File references preferred</strong> - Keep <code>sop.json</code> readable; content lives in <code>sop/</code></li>
    <li><strong>Gitignore .claude/</strong> - Regenerate from source; commit only if needed for teams without the engine</li>
    <li><strong>Single generator file</strong> - All generation logic in one ~280-line file; split when complexity warrants it</li>
    <li><strong>No plugins yet</strong> - Ship core first, add extensibility when patterns emerge</li>
  </ul>

</body>
</html>
